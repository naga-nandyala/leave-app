{% extends "base.html" %}

{% block title %}Team OOO Calendar - Team Availability{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>{{ month_name }} {{ year }}</h2>
                <p class="text-muted mb-0">Showing only team members who are out of office</p>
            </div>
            <div>
                <a href="{{ url_for('index', year=year if month > 1 else year-1, month=month-1 if month > 1 else 12) }}" class="btn btn-outline-primary">&lt; Previous</a>
                <a href="{{ url_for('index', year=year if month < 12 else year+1, month=month+1 if month < 12 else 1) }}" class="btn btn-outline-primary">Next &gt;</a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="table-responsive">
            <table class="table table-bordered calendar-table">
                <thead class="table-dark">
                    <tr>
                        <th>Monday</th>
                        <th>Tuesday</th>
                        <th>Wednesday</th>
                        <th>Thursday</th>
                        <th>Friday</th>
                        <th>Saturday</th>
                        <th>Sunday</th>
                    </tr>
                </thead>
                <tbody>
                    {% for week in calendar_data %}
                    <tr>
                        {% for day in week %}
                        <td class="calendar-day" data-date="{{ date_str if day != 0 else '' }}">
                            {% if day != 0 %}
                                {% set date_str = "%04d-%02d-%02d"|format(year, month, day) %}
                                <div class="day-header">
                                    <strong>{{ day }}</strong>
                                    <button class="btn btn-sm btn-outline-primary add-ooo-btn" data-date="{{ date_str }}" title="Add Out of Office">+</button>
                                </div>
                                <div class="day-content">
                                    {% if date_str in availability %}
                                        {% for member_id, avail_info in availability[date_str].items() %}
                                            {% if not avail_info.available %}
                                                {% set member = members[member_id] %}
                                                <div class="member-status unavailable" data-member-id="{{ member_id }}" data-date="{{ date_str }}">
                                                    <small>
                                                        {% if avail_info.reason.startswith('OOO:') %}
                                                            {{ member.name }} | OOO
                                                            <br>
                                                            <button class="btn btn-xs btn-outline-info view-ooo-btn" data-member-id="{{ member_id }}" data-date="{{ date_str }}" title="View/Edit OOO">✎</button>
                                                            <button class="btn btn-xs btn-outline-danger delete-ooo-btn" data-member-id="{{ member_id }}" data-date="{{ date_str }}" title="Cancel Vacation">×</button>
                                                        {% else %}
                                                            {{ member.name }} | {{ member.country }}{% if member.region %}, {{ member.region }}{% endif %} (public holiday)
                                                        {% endif %}
                                                    </small>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>Legend</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="member-status unavailable d-inline-block me-2">Out of Office</div>
                        <span>Team members who are away (Holiday or OOO)</span>
                    </div>
                    <div class="col-md-4">
                        <p class="text-muted mb-0"><small>Note: Only showing employees who are out of office</small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add OOO Modal -->
<div class="modal fade" id="addOOOModal" tabindex="-1" aria-labelledby="addOOOModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addOOOModalLabel">Add Out of Office</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addOOOForm">
                    <input type="hidden" id="ooo-start-date" name="start_date">
                    <div class="mb-3">
                        <label for="ooo-member" class="form-label">Team Member</label>
                        <select class="form-control" id="ooo-member" name="member_id" required>
                            <option value="">Select Member</option>
                            {% for member_id, member in members.items() %}
                                <option value="{{ member_id }}">{{ member.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="ooo-end-date" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="ooo-end-date" name="end_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="ooo-reason" class="form-label">Reason</label>
                        <select class="form-control" id="ooo-reason" name="reason">
                            <option value="Vacation">Vacation</option>
                            <option value="Sick Leave">Sick Leave</option>
                            <option value="Personal">Personal</option>
                            <option value="Conference">Conference</option>
                            <option value="Training">Training</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveOOOBtn">Add OOO</button>
            </div>
        </div>
    </div>
</div>

<!-- View OOO Details Modal -->
<div class="modal fade" id="viewOOOModal" tabindex="-1" aria-labelledby="viewOOOModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewOOOModalLabel">Out of Office Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="ooo-details-content">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="cancelVacationBtn">Cancel Entire Vacation</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentOOODetails = null;

    // Add OOO functionality
    document.querySelectorAll('.add-ooo-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const date = this.getAttribute('data-date');
            document.getElementById('ooo-start-date').value = date;
            document.getElementById('ooo-end-date').value = date;
            
            // Show selected date in modal title
            const modal = new bootstrap.Modal(document.getElementById('addOOOModal'));
            document.getElementById('addOOOModalLabel').textContent = `Add Out of Office - ${date}`;
            modal.show();
        });
    });

    // View OOO details functionality
    document.querySelectorAll('.view-ooo-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const memberId = this.getAttribute('data-member-id');
            const date = this.getAttribute('data-date');
            
            // Fetch OOO details
            fetch(`/api/ooo_details/${memberId}/${date}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentOOODetails = {
                            memberId: memberId,
                            entry: data.entry
                        };
                        
                        // Populate modal content
                        const content = document.getElementById('ooo-details-content');
                        content.innerHTML = `
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">${data.member_name}</h6>
                                    <p class="card-text">
                                        <strong>From:</strong> ${data.entry.start_date}<br>
                                        <strong>To:</strong> ${data.entry.end_date}<br>
                                        <strong>Reason:</strong> ${data.entry.reason}<br>
                                        <strong>Duration:</strong> ${data.duration} day(s)
                                    </p>
                                </div>
                            </div>
                        `;
                        
                        // Show modal
                        const modal = new bootstrap.Modal(document.getElementById('viewOOOModal'));
                        modal.show();
                    } else {
                        alert('Error fetching OOO details: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error fetching OOO details');
                });
        });
    });

    // Save OOO functionality
    document.getElementById('saveOOOBtn').addEventListener('click', function() {
        const form = document.getElementById('addOOOForm');
        const formData = new FormData(form);
        
        fetch('/add_ooo', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal and refresh page
                bootstrap.Modal.getInstance(document.getElementById('addOOOModal')).hide();
                location.reload();
            } else {
                alert('Error adding OOO: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding OOO');
        });
    });

    // Cancel entire vacation functionality
    document.getElementById('cancelVacationBtn').addEventListener('click', function() {
        if (currentOOODetails && confirm('Are you sure you want to cancel this entire vacation/OOO period?')) {
            fetch('/cancel_vacation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    member_id: currentOOODetails.memberId,
                    start_date: currentOOODetails.entry.start_date,
                    end_date: currentOOODetails.entry.end_date
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('viewOOOModal')).hide();
                    location.reload();
                } else {
                    alert('Error canceling vacation: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error canceling vacation');
            });
        }
    });

    // Delete single day OOO functionality (quick delete)
    document.querySelectorAll('.delete-ooo-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const memberId = this.getAttribute('data-member-id');
            const date = this.getAttribute('data-date');
            
            if (confirm('Are you sure you want to remove this OOO entry for this specific day?')) {
                fetch('/delete_ooo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        member_id: memberId,
                        date: date
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error deleting OOO: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting OOO');
                });
            }
        });
    });
});
</script>
{% endblock %}
